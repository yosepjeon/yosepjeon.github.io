+++
title = "Chapter 11. 옵저버빌리티와 모니터링 다루기"
date = "2025-12-30"
weight = 11
+++

# 11.1 관측 가능성에 대해 알아보자
시스템이 `관측 가능한` 상태가 되기위해 해야하는것(CNCF의 백서 참고)
* 시스템의 출력을 signal이라고 하며, 선호하는 시그널을 하나 선택하는 것으로 시작하는것이 좋다.
* signal에는 주요 시그널 3개와 신규 시그널 2개가 있으며, 주요 시그널부터 시작하는 것이 좋다.

#### 주요 시그널 3개
* Logs(로그)
* Metrics(메트릭)
* Traces(트레이스)

#### 신규 시그널 2개
* Profiles(프로파일)
* Dumps(덤프)

이 장에서는 주요 시그널 3개의 의미와 이를 도입하기 위한 대표적인 OSS를 소개합니다.

## 11.1.1 정보 수집하기: 로그
로그를 통해 `언제, 무엇이 일어났는지` 알 수 있습니다. 쿠버네티스에는 `kubectl logs`와 같이 기본으로 설정된 로그 수집 메커니즘이 있어 
컨테이너의 표준 출력/오류를 컨테이너의 로그로 수집합니다. 그러나 기본으로 수집되는 로그는 pod가 노드에서 삭제되면 사라집니다. 
따라서 실제 운영 환경에서는 로그를 필요한 만큼 더 오래 저장할 수 있는 메커니즘이 필요합니다.  
  
쿠버네티스 퍼시스턴트 볼륨에 저장하는 것도 좋지만, 외부로 전송하여 저장할 수도 있습니다.  
  
클라우드 서비스를 사용하는 경우, 클라우드 업체에서 제공하는 로그 저장 및 검색 서비스를 사용하면 다른 클라우드 서비스(AWS Lambda 같은 서버리스 서비스)의 
로그도 함께 볼 수 있어서 활용도가 높습니다.  
  
* Fluentd: 로그를 외부로 전송하기 위해 자주 사용되는 OSS
* Grafana Loki: 로그 저장 및 검색을 위한 OSS

## 11.1.2 측정값 처리하기: 메트릭스
메트릭스는 측정값의 집합입니다. 측정값에 대한 통계 처리를 하거나 경향을 파악하고자 할 때 활용합니다. 매트릭스도 로그오 마찬가지로 클라우드 서비스를 
사용할 수 있지만, 더 많은 기능을 제공하는 외부 클라우드 서비스(Datadog)를 이용하는 경우도 많습니다. 쿠버네티스는 기본적으로 메트릭스를 수집하는 기능이 없습니다. 
따라서 메트릭스를 수집하기 위해서는 외부 서비스를 이용해야 합니다. 

* Prometheus: PromQL이라는 쿼리를 사용하여 수집한 메트릭스를 조회할 수 있는 메트릭스 수집 OSS
  
## 11.1.3 통신 추적하기: 트레이스
``` bash
                서비스 A가 처리 완료까지 걸린 시간
│<------------------------------------------------------------>│
│  ┌─────────────────────────────────────────────────────────┐  
│  │                         Trace                           │  
│  └─────────────────────────────────────────────────────────┘  
│
│        ┌───────────────┐
│        │     Span      │
│        └───────────────┘
│         └─ 서비스 B 호출
│
│                         ┌───────────────────────────┐
│                         │           Span            │
│                         └───────────────────────────┘
│                          └─ 데이터베이스 쓰기 작업
│
└───────────────────────────────────────────────────────────────► (time)

```
트레이스는 사용자 혹은 애플리케이션의 통신을 추적하기 위한 개념입니다.  
Trace는 여러개의 span(작업의 집합)으로 구성됩니다. 여러 컨테이너가 실행되는 상황에서 장애가 발생했을 때, 사용자의 요청이 어떤 컨테이너를 
거쳤는지 정확히 추적해야 할 때 유용합니다.  
  
* Trace는 `어떤 요청에 얼마나 시간이 걸렸는지`를 세밀하게 시각화할 수 있어 성능 개선 및 튜닝에도 활용할 수 있습니다.
* 로그나 메트릭스와 달리 특정 컴포넌트나 인프라에만 트레이싱을 도입하는것은 의미가 없습니다.
* 정확한 추적을 위해서는 요청이 통과하는 경로의 모든 곳에 Trace/Span이 도입되어야합니다.
* 트레이스를 도입하기 위해서는 애플리케이션의 구현에서 어디서부터 어디까지 요청을 트레이스로 처리하고, 스팬으로 처리할지를 정의해야합니다.

* OpenTelemetry: 트레이스 외에도 메트릭스나 로그등의 데이터 표준 사양을 정하거나 도구를 제공하는 CNCF 프로젝트

# 11.2 모니터링에 대해 알아보기
## 11.2.1 정보를 시각화하기: 대시보드
관측 가능성은 데이터를 수집하는 것만으로는 실현되지 않습니다. 관측을 위해서는 시각화가 필요합니다. 대표적인 OSS로는 Grafana가 있습니다. Grafana는 Prometheus, Loki, Tempo와 궁합이 무척 잘 맞습니다.

## 11.2.2 이상 경보: 알림
관측 가능한 상태가 되면 이상이 발생했을 때 빠르게 대응할 수 있도록 알림 설정을 해야합니다. 알림 설정 방법과 모니터링 노하우에 대해서는 한권의 책이 나올 정도로 다양한 방법이 있습니다. 
대표적인 OSS로는 Prometheus에 포함된 AlertManager가 있습니다.

# 11.3 모니터링 시스템 구축하기
```bash
┌──────────────┐     연동       ┌──────────────┐
│ Prometheus   │──────────────▶│   Grafana    │
└──────────────┘               └──────────────┘
      │                              │
      │                              │  본다
      │  Scrape                      └───────────▶  /\_/\ 
      ▼                                            ( •.• )  💻
 ┌─────────────────┐                                /   \
 │   애플리케이션     │
 └─────────────────┘

```

## 11.3.1 Prometheus/Grafana 설치하기
(1) https://helm.sh/docs/intro/install/을 참고하여 Helm을 설치합니다.

(2) 다음 명령어를 실행하여 Helm 리포지터리를 추가합니다.  
<mark>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts</mark>  
<mark>helm repo update</mark>  
(3) <mark>kubectl create namespace monitoring</mark> 명령어를 실행하여 네임스페이스를 생성합니다.  

(4) 다음 명령어를 실행하여 Helm Chart를 설치합니다.  
<mark>helm install kube-prometheus-stack --namespace monitoring prometheus-community/ kube-prometheus-stack</mark>

명령어를 실행하여 모든 pod가 Running 상태가 되면 설치가 완료된것입니다.
```bash
kubectl get pod --namespace monitoring
NAME                                                       READY   STATUS    RESTARTS   AGE
alertmanager-kube-prometheus-stack-alertmanager-0          2/2     Running   0          93m
kube-prometheus-stack-grafana-66494876ff-pd5fn             3/3     Running   0          93m
kube-prometheus-stack-kube-state-metrics-669dcf4b9-jtgx2   1/1     Running   0          93m
kube-prometheus-stack-operator-7685dd7d99-jqmz9            1/1     Running   0          93m
kube-prometheus-stack-prometheus-node-exporter-dhnpv       1/1     Running   0          93m
prometheus-kube-prometheus-stack-prometheus-0              2/2     Running   0          93m
```

## 11.3.2 메트릭스 수집 애플리케이션 실행하기
관측 가능성은 관측할 대상이 존재해야 성립합니다. 따라서 먼저 애플리케이션을 실행하겠습니다. 이전에 등장했던 hello-server 애플리케이션을 사용합니다. 
지금까지와의 차이점은 메트릭스용 엔드포인트를 추가한다는 점입니다.  

* Prometheus는 `/metics`라는 엔드포인트에 접근하여 메트릭스를 수집합니다.
* `/metrics`에서 어떤 메트릭스를 수집할지는 애플리케이션 개발자의 자유입니다.