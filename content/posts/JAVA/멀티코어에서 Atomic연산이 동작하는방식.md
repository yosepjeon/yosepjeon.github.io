+++
title = "멀티코어에서 Atomic연산이 동작하는방식"
date = "2023-02-11"
weight = 2
+++

# 멀티코어에서 Atomic연산이 동작하는방식
학습을 진행하면서, 문득 이런 의문이 하나 생겼습니다.
"Atomic연산이 멀티코어 환경에서 어떻게 동작하지?"
- 프로그램 전체가 “한 번에 하나씩만 실행”되는 게 아니라 특정 메모리 위치(Atomic 변수 1개) 에 대한 read-modify-write 갱신만 원자적으로(선형화되게) 보장되는 것!


## Mac기준 16코어 환경에서 어떻게 1개씩 성공하는지?
### 1) Atomic 연산은 "CAS 시도"로 경쟁을 붙인다.
여러 코어가 동시에 `X`를 증각시키려 할 때의 tuesdo 코드입니다.
이 CAS연산이 단 1개의 코어에서만 일어나도록 CPU가 보장합니다.
```tuusdo
repeat:
    old = load(X)
    new = old + 1
until CAS(X, old, new) succeeds
```

### 2) CPU는 "캐시 일관성(coherence)"으로 그 메모리 주소를 한 코어만 수정 가능하게 만든다.
현대의 CPU는 보통 캐시 라인단위(예: 64바이트)로 "이 라인을 누가 수정할 권한이 있는지"를 조정합니다.  
즉, `X`가 속한 캐시 라인을 16코어 중 1개 코어만 "수정 가능(modified)" 상태로 만듭니다.
